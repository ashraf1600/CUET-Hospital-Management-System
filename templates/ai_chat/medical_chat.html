{% extends 'partials/base.html' %}
{% load static %}

{% block content %}

<style>
    body { background: #f5f7fa; }

    .chat-container {
        max-width: 850px;
        margin: auto;
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }

    .chat-box {
        height: 500px;
        overflow-y: auto;
        padding: 15px;
        border-radius: 10px;
        background: #eef5f0;
        border: 1px solid #cdd8cf;
    }

    .user-msg {
        text-align: right;
        margin-bottom: 15px;
    }

    .user-bubble {
        display: inline-block;
        background: #860000; /* CUET Maroon */
        color: white;
        padding: 10px 15px;
        border-radius: 12px;
        max-width: 70%;
    }

    .ai-msg {
        text-align: left;
        margin-bottom: 15px;
    }

    .ai-bubble {
        display: inline-block;
        background: #0e6b3d; /* CUET Green */
        color: white;
        padding: 12px 16px;
        border-radius: 12px;
        max-width: 75%;
        white-space: pre-line;
    }

    .typing {
        display: inline-block;
        padding: 10px 15px;
        background: #0e6b3d;
        border-radius: 12px;
        color: white;
    }

    .dot {
        height: 8px;
        width: 8px;
        margin: 0 2px;
        background: white;
        border-radius: 50%;
        display: inline-block;
        animation: blink 1.4s infinite;
    }

    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes blink {
        0% { opacity: .2; }
        20% { opacity: 1; }
        100% { opacity: .2; }
    }

</style>

<div class="container py-4">
    <h2 class="text-center mb-4 fw-bold" style="color:#0e6b3d;">AI Medical Assistant</h2>

    <div class="chat-container">
        <div id="chat-box" class="chat-box"></div>

        <form id="chat-form" class="mt-3">
            {% csrf_token %}
            <div class="input-group">
                <input id="symptoms-input" type="text" class="form-control" placeholder="Describe your symptoms...">
                <button class="btn btn-success" type="submit">Send</button>
            </div>
        </form>
    </div>
</div>

<script>
document.getElementById("chat-form").addEventListener("submit", function(e){
    e.preventDefault();

    let symptoms = document.getElementById("symptoms-input").value.trim();
    if (!symptoms) return;

    let box = document.getElementById("chat-box");

    // Show user bubble
    box.innerHTML += `
        <div class="user-msg">
            <div class="user-bubble">${symptoms}</div>
        </div>
    `;

    document.getElementById("symptoms-input").value = "";

    // Typing animation
    let typingId = "typing-" + Date.now();
    box.innerHTML += `
        <div id="${typingId}" class="ai-msg">
            <div class="typing">
                <span class="dot"></span><span class="dot"></span><span class="dot"></span>
            </div>
        </div>
    `;
    box.scrollTop = box.scrollHeight;

    // Send POST request
    fetch("{% url 'base:ai_chat' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: "symptoms=" + encodeURIComponent(symptoms)
    })
    .then(res => res.json())
    .then(data => {
        document.getElementById(typingId).remove();

        if (data.success) {
            box.innerHTML += `
                <div class="ai-msg">
                    <div class="ai-bubble">${data.response}</div>
                </div>
            `;
        } else {
            box.innerHTML += `
                <div class="ai-msg">
                    <div class="ai-bubble bg-danger">${data.error}</div>
                </div>
            `;
        }

        box.scrollTop = box.scrollHeight;
    });
});
</script>

{% endblock %}
